<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßü Zombie Apocalypse Survival Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- MENU SCREEN -->
        <div id="menuScreen">
            <div class="menu-content">
                <div class="menu-header">
                    <div class="menu-titles">
                        <h1>üßü ZOMBIE APOCALYPSE üßü</h1>
                        <p class="subtitle">REST API Survival Game</p>
                    </div>
                </div>

                <div class="menu-bottom">
                    <div class="game-box">
                        <div class="input-group">
                            <input
                                type="text"
                                id="nameInput"
                                placeholder="Enter your name..."
                                autofocus
                            >
                        </div>
                        <button id="startBtn" onclick="startGame()">Start Game</button>
                    </div>

                    <div class="leaderboard hidden" id="leaderboardBox">
                        <h3>üèÜ Leaderboard</h3>
                        <div id="leaderboardList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="gameScreen">
            <div class="header">
                <div class="day-counter" id="dayCounter">Day 1</div>
                <div class="survivor-name" id="survivorName">Survivor: Unknown</div>
            </div>

            <div class="stats-grid">
                <div class="stat">
                    <div class="stat-icon">‚ù§</div>
                    <div class="stat-label">Health</div>
                    <div class="stat-value" id="healthStat">100</div>
                </div>
                <div class="stat">
                    <div class="stat-icon">üçñ</div>
                    <div class="stat-label">Hunger</div>
                    <div class="stat-value" id="hungerStat">100</div>
                </div>
                <div class="stat">
                    <div class="stat-icon">üòä</div>
                    <div class="stat-label">Morale</div>
                    <div class="stat-value" id="moraleStat">100</div>
                </div>
                <div class="stat">
                    <div class="stat-icon">üè†</div>
                    <div class="stat-label">Shelter</div>
                    <div class="stat-value" id="shelterStat">0</div>
                </div>
                <div class="stat">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Allies</div>
                    <div class="stat-value" id="alliesStat">0</div>
                </div>
            </div>

            <div class="decisions-grid">
                <button class="decision-btn" onclick="makeDecision('shelter')">
                    <span class="btn-icon">üè†</span>
                    <div class="btn-title">Build Shelter</div>
                    <div class="btn-desc">Costs hunger, +30 safety</div>
                </button>
                <button class="decision-btn" onclick="makeDecision('food')">
                    <span class="btn-icon">üçñ</span>
                    <div class="btn-title">Hunt Food</div>
                    <div class="btn-desc">Risky, restores hunger</div>
                </button>
                <button class="decision-btn" onclick="makeDecision('allies')">
                    <span class="btn-icon">üë•</span>
                    <div class="btn-title">Find Allies</div>
                    <div class="btn-desc">Meet survivors, +morale</div>
                </button>
                <button class="decision-btn" onclick="makeDecision('rest')">
                    <span class="btn-icon">üò¥</span>
                    <div class="btn-title">Rest</div>
                    <div class="btn-desc">Heal, safe choice</div>
                </button>
            </div>

            <div class="api-log">
                <h3>üì° API Calls</h3>
                <div id="apiLogContent" class="api-log-content"></div>
            </div>
        </div>

        <!-- GAME OVER SCREEN -->
        <div id="gameoverScreen">
            <div class="gameover-title" id="gameoverTitle">üíÄ DEAD</div>
            <div class="score-box">
                <p>Final Score: <strong id="finalScore">0</strong></p>
                <p>Days Survived: <strong id="finalDays">0</strong></p>
            </div>
            <button onclick="backToMenu()" style="max-width: 300px;">Play Again</button>
        </div>
    </div>

<script>
    const API_BASE = 'http://localhost:3001/api';
    let currentSurvivor = null;
    let apiLog = [];
    let isLoading = false;

    window.onload = () => fetchLeaderboard();

    // Start Game
    async function startGame() {
        const name = document.getElementById('nameInput').value || 'Survivor';
        const result = await callAPI('POST', '/survivors', { name });

        if (result?.survivor) {
            currentSurvivor = result.survivor;
            showGameScreen();
            updateStats();
        }
    }

    // Make Decision
    async function makeDecision(decision) {
        if (isLoading) return;

        const result = await callAPI(
            'POST',
            `/survivors/${currentSurvivor.id}/decisions`,
            { decision }
        );

        if (result?.survivor) {
            currentSurvivor = result.survivor;
            updateStats();

            if (['dead', 'escaped'].includes(currentSurvivor.status)) {
                setTimeout(() => endGame(), 500);
            }
        }
    }

    // API Caller
    async function callAPI(method, endpoint, body = null) {
        const fullURL = `${API_BASE}${endpoint}`;
        addApiLog('request', `${method} ${endpoint}`);

        isLoading = true;
        updateButtonStates();

        try {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(fullURL, options);
            const data = await response.json();

            addApiLog('response', data.message || 'Success');
            return data;

        } catch (error) {
            addApiLog('error', `Error: ${error.message}`);
            return null;

        } finally {
            isLoading = false;
            updateButtonStates();
        }
    }

    // Leaderboard
    async function fetchLeaderboard() {
        const result = await callAPI('GET', '/leaderboard');
        if (result?.leaderboard) displayLeaderboard(result.leaderboard);
    }

    function displayLeaderboard(leaderboard) {
        const box = document.getElementById('leaderboardBox');
        const list = document.getElementById('leaderboardList');

        if (leaderboard.length === 0) return;

        list.innerHTML = leaderboard
            .map((entry, i) => `
                <div class="leaderboard-entry">
                    <span>${i + 1}. ${entry.name}</span>
                    <span>${entry.score} pts (${entry.days}d)</span>
                </div>
            `)
            .join('');

        box.classList.remove('hidden');
    }

    // Update Stats
    function updateStats() {
        document.getElementById('dayCounter').textContent = `Day ${currentSurvivor.day}`;
        document.getElementById('survivorName').textContent = `Survivor: ${currentSurvivor.name}`;
        document.getElementById('healthStat').textContent = currentSurvivor.health;
        document.getElementById('hungerStat').textContent = currentSurvivor.hunger;
        document.getElementById('moraleStat').textContent = currentSurvivor.morale;
        document.getElementById('shelterStat').textContent = currentSurvivor.shelter;
        document.getElementById('alliesStat').textContent = currentSurvivor.allies * 20;
    }

    // API LOG
    function addApiLog(type, message) {
        const time = new Date().toLocaleTimeString();
        const logContent = document.getElementById('apiLogContent');

        const div = document.createElement('div');
        div.className = `api-log-entry ${type}`;
        div.innerHTML = `<span class="time">[${time}]</span> ${message}`;

        logContent.prepend(div);
    }

    // End Game
    async function endGame() {
        const entry = {
            name: currentSurvivor.name,
            score: currentSurvivor.score,
            days: currentSurvivor.day,
            survived: currentSurvivor.status === 'escaped'
        };

        await callAPI('POST', '/leaderboard', entry);

        document.getElementById('gameoverTitle').textContent =
            currentSurvivor.status === 'escaped' ? '‚ú® ESCAPED!' : 'üíÄ DEAD';
        document.getElementById('finalScore').textContent = currentSurvivor.score;
        document.getElementById('finalDays').textContent = currentSurvivor.day;

        showGameoverScreen();
    }

    // Screen switches
    function showGameScreen() {
        document.getElementById('menuScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.add('active');
    }

    function showGameoverScreen() {
        document.getElementById('gameScreen').classList.remove('active');
        document.getElementById('gameoverScreen').classList.add('active');
    }

    function backToMenu() {
        document.getElementById('gameoverScreen').classList.remove('active');
        document.getElementById('menuScreen').classList.remove('hidden');
        document.getElementById('nameInput').value = '';

        apiLog = [];
        document.getElementById('apiLogContent').innerHTML = '';

        fetchLeaderboard();
    }

    function updateButtonStates() {
        const buttons = document.querySelectorAll('.decision-btn, #startBtn');
        buttons.forEach(btn => (btn.disabled = isLoading));
    }
</script>
</body>
</html>
